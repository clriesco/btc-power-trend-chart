<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin Power Trend Chart</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
        }
        .halving-countdown {
            text-align: center;
            margin: 10px 0 20px 0;
            padding: 10px;
            background-color: #fff3cd;
            border-radius: 5px;
            border: 1px solid #ffc107;
        }
        .halving-countdown h3 {
            margin: 5px 0;
            color: #856404;
        }
        .halving-countdown .countdown {
            font-size: 18px;
            font-weight: bold;
            color: #856404;
        }
        .chart-container {
            min-height: 600px;
            margin-bottom: 20px;
        }
        .oscillator-container {
            min-height: 300px;
        }
        .description {
            margin-top: 30px;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 5px;
            line-height: 1.6;
        }
        .nav-links {
            text-align: center;
            margin: 20px 0;
        }
        .nav-links a {
            display: inline-block;
            margin: 0 10px;
            padding: 8px 16px;
            background-color: #f7931a;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-weight: bold;
        }
        .nav-links a:hover {
            background-color: #e87b0c;
        }
        .info-panel {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 10px 16px;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            margin-bottom: 12px;
            font-size: 14px;
            min-height: 36px;
            color: #666;
        }
        .info-panel .ip-date {
            font-weight: bold;
            color: #333;
            min-width: 100px;
        }
        .info-panel .ip-label {
            color: #888;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .info-panel .ip-value {
            font-weight: 600;
            font-size: 15px;
        }
        .info-panel .ip-section {
            display: flex;
            flex-direction: column;
            gap: 1px;
        }
        .info-panel .ip-gauge {
            display: flex;
            flex-direction: column;
            gap: 2px;
            min-width: 140px;
        }
        .info-panel .ip-gauge-track {
            width: 100%;
            height: 8px;
            background: linear-gradient(to right, #28a745, #28a745 2.5%, #6c757d 2.5%, #6c757d 16.5%, #adb5bd 16.5%, #adb5bd 83.5%, #6c757d 83.5%, #6c757d 97.5%, #dc3545 97.5%, #dc3545);
            border-radius: 4px;
            position: relative;
        }
        .info-panel .ip-gauge-marker {
            position: absolute;
            top: -3px;
            width: 4px;
            height: 14px;
            background: #333;
            border-radius: 2px;
            transform: translateX(-50%);
        }
        .info-panel .ip-default-text {
            color: #aaa;
            font-style: italic;
        }
    </style>
    <!-- HighCharts Dependencies -->
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>
    <!-- Constants -->
    <script src="constants.js"></script>
</head>
<body>
    <div class="container">
        <h1>Bitcoin Power Trend Chart</h1>
        
        <div class="halving-countdown" id="halving-countdown">
            <h3>Next Halving (H5)</h3>
            <div class="countdown" id="countdown-text">Calculating...</div>
        </div>
        
        <div class="nav-links">
            <a href="index.html" class="active">View Normal Chart</a>
            <a href="log-log-chart.html">View Log-Log Chart</a>
            <a href="outlier_analysis.html">View Outlier Analysis</a>
        </div>
        
        <div id="info-panel" class="info-panel">
            <span class="ip-default-text">Hover over the chart to see details</span>
        </div>
        <div id="chart-container" class="chart-container"></div>
        <div id="oscillator-container" class="oscillator-container"></div>
        
        <div class="description">
            <h2>About the Chart</h2>
            <p>This chart shows the price of Bitcoin from its genesis block (January 3, 2009) to today, with the power trend line and its percentile bands.</p>
            <p>The trend line follows a power law model defined by the formula: <strong>y = ax<sup>b</sup></strong></p>
            <p>Where:</p>
            <ul>
                <li>a (intercept coefficient): 1.47E-17</li>
                <li>b (slope coefficient): 5.78</li>
            </ul>
            <p>The percentile bands shown around the trend line are similar to standard deviations used in statistics, but they do not assume a bell curve.</p>
            <ul>
                <li>Between the red bands (2.5 and 97.5 percentiles) represents 95% of observations</li>
                <li>Between the blue bands (16.5 and 83.5 percentiles) represents 67% of observations</li>
            </ul>
            <h3>Power Law Oscillator</h3>
            <p>The oscillator below shows the normalized deviation from the power trend line. It eliminates the upward slope to show only market "volatility" or "temperature" on a horizontal scale, making it easier to identify periods of overvaluation or undervaluation relative to the long-term power law trend.</p>
            
            <h4>Why Use Logarithms?</h4>
            <p>Bitcoin's price has grown exponentially over time, following a power law relationship. This means that a $1,000 deviation from the trend in 2010 represents a much larger percentage change than a $1,000 deviation in 2024. Using logarithms normalizes these differences, making them comparable across different time periods.</p>
            
            <h4>Mathematical Foundation</h4>
            <p>The oscillator is calculated using the formula:</p>
            <p style="text-align: center; font-family: monospace; background-color: #f0f0f0; padding: 10px; border-radius: 4px;"><strong>Oscillator = log₁₀(Actual Price) - log₁₀(Trend Price)</strong></p>
            <p>This formula transforms the multiplicative relationship between actual price and trend price into an additive one. In logarithmic space:</p>
            <ul>
                <li><strong>Positive values</strong>: The actual price is above the trend line (overvalued relative to trend)</li>
                <li><strong>Negative values</strong>: The actual price is below the trend line (undervalued relative to trend)</li>
                <li><strong>Zero value</strong>: The actual price exactly matches the trend line</li>
            </ul>
            
            <h4>Understanding the Scale</h4>
            <p>The oscillator uses a logarithmic scale, which means:</p>
            <ul>
                <li><strong>+0.3</strong>: The price is approximately 2× (10^0.3 ≈ 2) the trend price</li>
                <li><strong>+0.6</strong>: The price is approximately 4× (10^0.6 ≈ 4) the trend price</li>
                <li><strong>-0.3</strong>: The price is approximately 0.5× (10^-0.3 ≈ 0.5) the trend price</li>
                <li><strong>-0.6</strong>: The price is approximately 0.25× (10^-0.6 ≈ 0.25) the trend price</li>
            </ul>
            
            <h4>Interpretation Zones</h4>
            <p>The oscillator chart is divided into three color-coded zones based on historical percentiles:</p>
            
            <p><strong>Green Zone (Oversold Conditions)</strong></p>
            <ul>
                <li><strong>Values ≤ 2.5th percentile</strong>: Historically, only 2.5% of observations fall at or below this level</li>
                <li><strong>Market condition</strong>: Extreme undervaluation relative to the power trend</li>
                <li><strong>Historical context</strong>: These periods have often preceded significant price increases</li>
                <li><strong>Risk/Reward</strong>: Higher potential reward, but timing entry can be challenging</li>
            </ul>
            
            <p><strong>Neutral Zone (Normal Range)</strong></p>
            <ul>
                <li><strong>Values between 2.5th and 97.5th percentiles</strong>: Represents 95% of historical observations</li>
                <li><strong>Market condition</strong>: Price is within normal historical deviation from trend</li>
                <li><strong>Trading context</strong>: Most of Bitcoin's history has been spent in this range</li>
            </ul>
            
            <p><strong>Red Zone (Overbought Conditions)</strong></p>
            <ul>
                <li><strong>Values ≥ 97.5th percentile</strong>: Historically, only 2.5% of observations fall at or above this level</li>
                <li><strong>Market condition</strong>: Extreme overvaluation relative to the power trend</li>
                <li><strong>Historical context</strong>: These periods have often preceded significant price corrections</li>
                <li><strong>Risk/Reward</strong>: Higher risk of correction, but timing exit can be challenging</li>
            </ul>
            
            <h4>Practical Applications</h4>
            
            <p><strong>1. Market Temperature Gauge</strong></p>
            <p>The oscillator serves as a "thermometer" for Bitcoin's market condition:</p>
            <ul>
                <li><strong>High positive values</strong> (red zone): Market is "hot" - prices are significantly above the long-term trend</li>
                <li><strong>Low negative values</strong> (green zone): Market is "cold" - prices are significantly below the long-term trend</li>
                <li><strong>Near zero</strong>: Market is "temperate" - prices align with the power law trend</li>
            </ul>
            
            <p><strong>2. Historical Context</strong></p>
            <p>By removing the upward trend, the oscillator allows you to:</p>
            <ul>
                <li>Compare market conditions across different eras (e.g., 2013 vs 2021)</li>
                <li>Identify when current conditions are similar to past extremes</li>
                <li>Understand that a $10,000 price in 2013 might be as "overvalued" as a $100,000 price in 2024</li>
            </ul>
            
            <p><strong>3. Trend Reversion Analysis</strong></p>
            <p>The oscillator helps identify:</p>
            <ul>
                <li><strong>Mean reversion opportunities</strong>: Extreme values tend to revert toward zero over time</li>
                <li><strong>Momentum continuation</strong>: Values near zero with strong momentum may continue</li>
                <li><strong>Cycle identification</strong>: Patterns of oscillation around the trend line</li>
            </ul>
            
            <p><strong>4. Risk Management</strong></p>
            <p>Use the oscillator to:</p>
            <ul>
                <li><strong>Set expectations</strong>: Understand when prices are at historical extremes</li>
                <li><strong>Position sizing</strong>: Consider reducing exposure in red zones, increasing in green zones</li>
                <li><strong>Time horizons</strong>: Extreme values may persist longer than expected, requiring patience</li>
            </ul>
            
            <h4>Advantages Over Other Metrics</h4>
            <ul>
                <li><strong>Time-normalized</strong>: Unlike percentage deviations, the oscillator accounts for Bitcoin's exponential growth</li>
                <li><strong>Trend-relative</strong>: Measures deviation from the power law trend, not arbitrary price levels</li>
                <li><strong>Historical perspective</strong>: Uses percentiles based on all historical data, not just recent periods</li>
                <li><strong>Visual clarity</strong>: The horizontal scale makes it easy to compare conditions across time</li>
            </ul>
            
            <h4>Limitations and Considerations</h4>
            <ul>
                <li><strong>Not a timing tool</strong>: Extreme values don't predict when reversals will occur</li>
                <li><strong>Trend adaptation</strong>: The power trend itself adjusts with new data, so the oscillator is relative, not absolute</li>
                <li><strong>Context matters</strong>: External factors (regulations, adoption, macro conditions) can override historical patterns</li>
                <li><strong>Past ≠ Future</strong>: Historical patterns may not repeat exactly</li>
            </ul>
            
            <h4>Synchronization with Price Chart</h4>
            <p>The oscillator chart is synchronized with the main price chart:</p>
            <ul>
                <li><strong>Shared X-axis</strong>: Both charts show the same time period</li>
                <li><strong>Zoom synchronization</strong>: Zooming or panning one chart automatically updates the other</li>
                <li><strong>Tooltip integration</strong>: Hovering over the price chart shows the corresponding oscillator value</li>
            </ul>
            <p>This synchronization allows you to see how price movements relate to trend deviations, identify periods when price and oscillator diverge, and analyze the relationship between price action and trend alignment.</p>
        </div>
    </div>

    <script>
        /**
         * Updates the countdown to the next halving
         */
        function updateHalvingCountdown() {
            if (!window.BTC_CONSTANTS) return;
            
            const halvings = window.BTC_CONSTANTS.HALVINGS;
            const now = new Date();
            
            // Find the next halving (future or projected)
            let nextHalving = null;
            for (let i = halvings.length - 1; i >= 0; i--) {
                const halvingDate = new Date(halvings[i].date);
                if (halvingDate > now) {
                    nextHalving = halvings[i];
                }
            }
            
            if (!nextHalving) {
                // If no future halving found, use the last projected one
                nextHalving = halvings[halvings.length - 1];
            }
            
            const countdownEl = document.getElementById('countdown-text');
            if (!countdownEl) return;
            
            const nextDate = new Date(nextHalving.date);
            const diff = nextDate - now;
            
            if (diff <= 0) {
                countdownEl.textContent = 'Halving completed';
                return;
            }
            
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            countdownEl.textContent = `${days} days, ${hours} hours, ${minutes} minutes until ${nextHalving.label}`;
        }

        /**
         * Gets halving plot lines for HighCharts
         * @returns {Array<Object>} Array of plot line configurations
         */
        function getHalvingPlotLines() {
            if (!window.BTC_CONSTANTS) return [];
            
            return window.BTC_CONSTANTS.HALVINGS.map((halving, index) => {
                const date = new Date(halving.date).getTime();
                const isProjected = halving.isProjected || false;
                
                return {
                    value: date,
                    color: isProjected ? '#999999' : '#666666',
                    width: isProjected ? 1 : 2,
                    dashStyle: isProjected ? 'dash' : 'solid',
                    label: {
                        text: halving.label,
                        align: 'left',
                        verticalAlign: 'top',
                        rotation: 0,
                        style: {
                            color: isProjected ? '#999999' : '#666666',
                            fontSize: '10px'
                        },
                        x: 5,
                        y: -5
                    },
                    zIndex: 1
                };
            });
        }

        /**
         * Calculates oscillator percentile bands
         * @param {Array} oscillatorData - Array of oscillator values
         * @returns {Object} Percentile band values
         */
        function calculateOscillatorBands(oscillatorData) {
            const values = oscillatorData.map(d => d[1]).filter(v => !isNaN(v) && isFinite(v));
            if (values.length === 0) return { lower: -1, upper: 1 };
            
            values.sort((a, b) => a - b);
            
            const percentile2_5 = values[Math.floor(values.length * 0.025)];
            const percentile97_5 = values[Math.floor(values.length * 0.975)];
            
            return {
                lower: percentile2_5 || -1,
                upper: percentile97_5 || 1
            };
        }

        /**
         * Gets color for oscillator area based on value
         * @param {number} value - Oscillator value
         * @param {Object} bands - Percentile bands
         * @returns {string} Color in rgba format
         */
        function getOscillatorColor(value, bands) {
            if (value <= bands.lower) {
                // Green for oversold
                return 'rgba(40, 167, 69, 0.3)';
            } else if (value >= bands.upper) {
                // Red for overbought
                return 'rgba(220, 53, 69, 0.3)';
            } else {
                // Neutral gray
                return 'rgba(128, 128, 128, 0.2)';
            }
        }

        /**
         * Loads Bitcoin data and renders the charts
         */
        async function loadDataAndRenderChart() {
            try {
                const response = await fetch('bitcoin_data.json');
                const data = await response.json();
                
                renderCharts(data);
                updateHalvingCountdown();
                // Update countdown every minute
                setInterval(updateHalvingCountdown, 60000);
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('chart-container').innerHTML = 
                    `<div style="color: red; padding: 20px; text-align: center;">
                        Error loading data. Please run "node fetch_bitcoin_data.js" first
                     </div>`;
            }
        }

        /**
         * Renders synchronized price and oscillator charts
         * @param {Object} data - Bitcoin price and trend data
         */
        function renderCharts(data) {
            // Prepare series data
            const priceData = data.prices.map(point => [new Date(point.date).getTime(), point.price]);
            const trendData = data.powerTrend.map(point => [new Date(point.date).getTime(), point.trendPrice]);
            const percentile2_5 = data.powerTrend.map(point => [new Date(point.date).getTime(), point.percentile2_5]);
            const percentile16_5 = data.powerTrend.map(point => [new Date(point.date).getTime(), point.percentile16_5]);
            const percentile83_5 = data.powerTrend.map(point => [new Date(point.date).getTime(), point.percentile83_5]);
            const percentile97_5 = data.powerTrend.map(point => [new Date(point.date).getTime(), point.percentile97_5]);
            
            // Prepare oscillator data
            const oscillatorData = data.powerTrend
                .filter(point => point.oscillator !== undefined && !isNaN(point.oscillator))
                .map(point => [new Date(point.date).getTime(), point.oscillator]);
            
            // Calculate oscillator bands
            const oscillatorBands = calculateOscillatorBands(oscillatorData);
            
            // Get halving plot lines
            const halvingPlotLines = getHalvingPlotLines();

            // Create price chart
            const priceChart = Highcharts.chart('chart-container', {
                chart: {
                    type: 'line',
                    zoomType: 'x',
                    panning: true,
                    panKey: 'shift',
                    backgroundColor: '#ffffff',
                    height: 600
                },
                title: {
                    text: 'Bitcoin Price',
                    style: {
                        fontSize: '24px'
                    }
                },
                subtitle: {
                    text: 'Based on the Power Trend Economics model',
                    style: {
                        fontSize: '16px'
                    }
                },
                xAxis: {
                    type: 'datetime',
                    crosshair: true,
                    title: {
                        text: 'Date'
                    },
                    plotLines: halvingPlotLines,
                    events: {
                        setExtremes: function(e) {
                            // Synchronize with oscillator chart (avoid infinite loops)
                            if (window.oscillatorChart && e.trigger && e.trigger !== 'sync') {
                                try {
                                    window.oscillatorChart.xAxis[0].setExtremes(e.min, e.max, false, { trigger: 'sync' });
                                } catch (err) {
                                    // Ignore sync errors
                                }
                            }
                        }
                    }
                },
                yAxis: {
                    type: 'logarithmic',
                    title: {
                        text: 'Price (USD)'
                    },
                    min: 0.01,
                    labels: {
                        formatter: function() {
                            return '$' + this.value.toLocaleString();
                        }
                    }
                },
                tooltip: {
                    enabled: false
                },
                legend: {
                    enabled: true,
                    layout: 'horizontal',
                    align: 'center',
                    verticalAlign: 'bottom'
                },
                plotOptions: {
                    line: {
                        marker: {
                            enabled: false
                        }
                    },
                    series: {
                        states: {
                            hover: {
                                lineWidthPlus: 0
                            }
                        }
                    }
                },
                series: [{
                    name: 'Bitcoin Price',
                    data: priceData,
                    color: '#f7931a',
                    lineWidth: 1,
                    zIndex: 5
                }, {
                    name: 'Power Trend',
                    data: trendData,
                    color: '#000000',
                    lineWidth: 2,
                    zIndex: 4
                }, {
                    name: 'Percentile 16.5',
                    data: percentile16_5,
                    color: '#3870b0',
                    lineWidth: 1,
                    zIndex: 3,
                    dashStyle: 'shortdash'
                }, {
                    name: 'Percentile 83.5',
                    data: percentile83_5,
                    color: '#3870b0',
                    lineWidth: 1,
                    zIndex: 3,
                    dashStyle: 'shortdash'
                }, {
                    name: 'Percentile 2.5',
                    data: percentile2_5,
                    color: '#bc3e3e',
                    lineWidth: 1,
                    zIndex: 2,
                    dashStyle: 'shortdot'
                }, {
                    name: 'Percentile 97.5',
                    data: percentile97_5,
                    color: '#bc3e3e',
                    lineWidth: 1,
                    zIndex: 2,
                    dashStyle: 'shortdot'
                }],
                responsive: {
                    rules: [{
                        condition: {
                            maxWidth: 500
                        },
                        chartOptions: {
                            legend: {
                                layout: 'horizontal',
                                align: 'center',
                                verticalAlign: 'bottom'
                            }
                        }
                    }]
                },
                exporting: {
                    enabled: true,
                    buttons: {
                        contextButton: {
                            menuItems: ['downloadPNG', 'downloadJPEG', 'downloadPDF', 'downloadCSV']
                        }
                    }
                }
            });

            // Create oscillator chart
            window.oscillatorChart = Highcharts.chart('oscillator-container', {
                chart: {
                    type: 'area',
                    zoomType: 'x',
                    panning: true,
                    panKey: 'shift',
                    backgroundColor: '#ffffff',
                    height: 300
                },
                title: {
                    text: 'Power Law Oscillator',
                    style: {
                        fontSize: '20px'
                    }
                },
                subtitle: {
                    text: 'Normalized deviation from power trend line',
                    style: {
                        fontSize: '14px'
                    }
                },
                xAxis: {
                    type: 'datetime',
                    crosshair: true,
                    title: {
                        text: 'Date'
                    },
                    plotLines: halvingPlotLines,
                    events: {
                        setExtremes: function(e) {
                            // Synchronize with price chart (avoid infinite loops)
                            if (priceChart && e.trigger && e.trigger !== 'sync') {
                                try {
                                    priceChart.xAxis[0].setExtremes(e.min, e.max, false, { trigger: 'sync' });
                                } catch (err) {
                                    // Ignore sync errors
                                }
                            }
                        }
                    }
                },
                yAxis: {
                    title: {
                        text: 'Oscillator Value'
                    },
                    plotLines: [{
                        value: 0,
                        color: '#000000',
                        width: 2,
                        zIndex: 5,
                        label: {
                            text: 'Trend Line (0)',
                            align: 'right',
                            style: {
                                color: '#666666'
                            }
                        }
                    }, {
                        value: oscillatorBands.lower,
                        color: '#28a745',
                        width: 1,
                        dashStyle: 'dash',
                        zIndex: 4,
                        label: {
                            text: '2.5% Percentile',
                            align: 'right',
                            style: {
                                color: '#28a745'
                            }
                        }
                    }, {
                        value: oscillatorBands.upper,
                        color: '#dc3545',
                        width: 1,
                        dashStyle: 'dash',
                        zIndex: 4,
                        label: {
                            text: '97.5% Percentile',
                            align: 'right',
                            style: {
                                color: '#dc3545'
                            }
                        }
                    }]
                },
                tooltip: {
                    enabled: false
                },
                legend: {
                    enabled: false
                },
                plotOptions: {
                    area: {
                        marker: {
                            enabled: false
                        },
                        threshold: 0,
                        fillOpacity: 0.3
                    }
                },
                series: (function() {
                    // Split oscillator data into zones by color
                    const oversoldData = [];
                    const neutralData = [];
                    const overboughtData = [];
                    
                    oscillatorData.forEach(point => {
                        const value = point[1];
                        if (value <= oscillatorBands.lower) {
                            oversoldData.push(point);
                        } else if (value >= oscillatorBands.upper) {
                            overboughtData.push(point);
                        } else {
                            neutralData.push(point);
                        }
                    });
                    
                    return [
                        {
                            name: 'Oscillator (Oversold)',
                            data: oversoldData,
                            color: '#28a745',
                            fillColor: {
                                linearGradient: {
                                    x1: 0,
                                    y1: 0,
                                    x2: 0,
                                    y2: 1
                                },
                                stops: [
                                    [0, 'rgba(40, 167, 69, 0.4)'],
                                    [1, 'rgba(40, 167, 69, 0.1)']
                                ]
                            },
                            lineWidth: 1,
                            zIndex: 3,
                            showInLegend: false
                        },
                        {
                            name: 'Oscillator (Neutral)',
                            data: neutralData,
                            color: '#6c757d',
                            fillColor: {
                                linearGradient: {
                                    x1: 0,
                                    y1: 0,
                                    x2: 0,
                                    y2: 1
                                },
                                stops: [
                                    [0, 'rgba(128, 128, 128, 0.3)'],
                                    [1, 'rgba(128, 128, 128, 0.1)']
                                ]
                            },
                            lineWidth: 1,
                            zIndex: 3,
                            showInLegend: false
                        },
                        {
                            name: 'Oscillator (Overbought)',
                            data: overboughtData,
                            color: '#dc3545',
                            fillColor: {
                                linearGradient: {
                                    x1: 0,
                                    y1: 0,
                                    x2: 0,
                                    y2: 1
                                },
                                stops: [
                                    [0, 'rgba(220, 53, 69, 0.4)'],
                                    [1, 'rgba(220, 53, 69, 0.1)']
                                ]
                            },
                            lineWidth: 1,
                            zIndex: 3,
                            showInLegend: false
                        }
                    ];
                })(),
                responsive: {
                    rules: [{
                        condition: {
                            maxWidth: 500
                        },
                        chartOptions: {
                            title: {
                                style: {
                                    fontSize: '16px'
                                }
                            }
                        }
                    }]
                },
                exporting: {
                    enabled: true,
                    buttons: {
                        contextButton: {
                            menuItems: ['downloadPNG', 'downloadJPEG', 'downloadPDF', 'downloadCSV']
                        }
                    }
                }
            });

            // Store reference for synchronization
            window.priceChart = priceChart;

            // --- Info panel update logic ---
            function formatPrice(v) {
                return '$' + v.toLocaleString(undefined, {
                    minimumFractionDigits: v < 1 ? 4 : 2,
                    maximumFractionDigits: v < 1 ? 4 : 2
                });
            }

            function updateInfoPanel(timestamp) {
                const panel = document.getElementById('info-panel');
                const dateStr = Highcharts.dateFormat('%Y-%m-%d', timestamp);
                const trendPoint = data.powerTrend.find(p => p.date === dateStr);
                // Find price
                const pricePoint = data.prices.find(p => p.date === dateStr);

                if (!trendPoint || !pricePoint) {
                    panel.innerHTML = '<span class="ip-default-text">Hover over the chart to see details</span>';
                    return;
                }

                const price = pricePoint.price;
                const trend = trendPoint.trendPrice;
                const p2_5 = trendPoint.percentile2_5;
                const p16_5 = trendPoint.percentile16_5;
                const p83_5 = trendPoint.percentile83_5;
                const p97_5 = trendPoint.percentile97_5;
                const oscillator = trendPoint.oscillator;

                // Calculate percentile position (0-100 scale)
                let pct = 50;
                if (price <= 0) {
                    pct = 0;
                } else if (price < p2_5) {
                    pct = Math.max(0, (price / p2_5) * 2.5);
                } else if (price < p16_5) {
                    pct = 2.5 + (price - p2_5) / (p16_5 - p2_5) * (16.5 - 2.5);
                } else if (price < trend) {
                    pct = 16.5 + (price - p16_5) / (trend - p16_5) * (50 - 16.5);
                } else if (price < p83_5) {
                    pct = 50 + (price - trend) / (p83_5 - trend) * (83.5 - 50);
                } else if (price < p97_5) {
                    pct = 83.5 + (price - p83_5) / (p97_5 - p83_5) * (97.5 - 83.5);
                } else {
                    pct = Math.min(100, 97.5 + (price - p97_5) / (p97_5 * 0.5) * 2.5);
                }

                // Color for price: red if below trend (undervalued), green if above
                const priceColor = price < trend ? '#dc3545' : '#28a745';

                panel.innerHTML =
                    '<div class="ip-section"><span class="ip-label">Date</span><span class="ip-date">' + Highcharts.dateFormat('%e %b %Y', timestamp) + '</span></div>' +
                    '<div class="ip-section"><span class="ip-label">BTC Price</span><span class="ip-value" style="color:' + priceColor + '">' + formatPrice(price) + '</span></div>' +
                    '<div class="ip-section"><span class="ip-label">Trend</span><span class="ip-value">' + formatPrice(trend) + '</span></div>' +
                    '<div class="ip-gauge"><span class="ip-label">Percentile ' + pct.toFixed(1) + '%</span><div class="ip-gauge-track"><div class="ip-gauge-marker" style="left:' + Math.max(0, Math.min(100, pct)) + '%"></div></div></div>' +
                    (oscillator !== undefined && !isNaN(oscillator) ? '<div class="ip-section"><span class="ip-label">Oscillator</span><span class="ip-value">' + oscillator.toFixed(4) + '</span></div>' : '');
            }

            // Wire hover events on both charts
            function addHoverSync(chart) {
                var container = chart.container;
                container.addEventListener('mousemove', function(e) {
                    var point, event;
                    event = chart.pointer.normalize(e);
                    // Find nearest point on first series
                    point = chart.series[0].searchPoint(event, true);
                    if (point) {
                        updateInfoPanel(point.x);
                        // Sync crosshair on the other chart
                        var otherChart = (chart === priceChart) ? window.oscillatorChart : priceChart;
                        if (otherChart) {
                            var otherPoint = otherChart.series[0].searchPoint(event, true);
                            if (otherPoint) {
                                otherChart.xAxis[0].drawCrosshair(event, otherPoint);
                            }
                        }
                    }
                });
                container.addEventListener('mouseleave', function() {
                    panel = document.getElementById('info-panel');
                    panel.innerHTML = '<span class="ip-default-text">Hover over the chart to see details</span>';
                });
            }

            addHoverSync(priceChart);
            addHoverSync(window.oscillatorChart);
        }

        // Load data and render charts when page loads
        document.addEventListener('DOMContentLoaded', loadDataAndRenderChart);
    </script>
</body>
</html>
